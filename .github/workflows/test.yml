name: 单元测试

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      test_passed:
        description: "测试是否通过"
        value: ${{ jobs.test.outputs.passed }}

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    outputs:
      passed: ${{ steps.test_result.outputs.passed }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
      
      - name: 设置 Go 环境
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: 运行测试
        id: test_result
        shell: bash
        run: |
          echo "开始运行测试..."
          
          # 列出所有包
          echo "📦 发现以下包："
          go list ./...
          
          # 逐个包进行测试
          echo "🔍 开始测试..."
          failed_pkgs=""
          
          for pkg in $(go list ./...); do
            echo "测试包: $pkg"
            # 运行测试并生成覆盖率报告
            if ! go test -v -cover -coverprofile=coverage.tmp $pkg; then
              echo "❌ $pkg 测试失败"
              failed_pkgs="$failed_pkgs\n$pkg"
            else
              # 显示覆盖率报告
              echo "📊 覆盖率报告："
              go tool cover -func=coverage.tmp
              echo "✅ $pkg 测试通过"
            fi
          done
          
          # 如果有失败的包，输出汇总并退出
          if [ ! -z "$failed_pkgs" ]; then
            echo -e "\n❌ 以下包测试失败：$failed_pkgs"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ 所有测试通过"
          echo "passed=true" >> $GITHUB_OUTPUT 